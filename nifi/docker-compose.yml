services:

  verify_required_env:
    image: hairyhenderson/gomplate:latest
    working_dir: /workspace
    env_file:
      - ./.env
      - ../.env-local
    command: "-i '{{env.Getenv \"DOCKER_HOST_OR_IP\" | required \"Mandatory DOCKER_HOST_OR_IP environment variable not found.\"}}'"

  setup_jars:
    image: debian:stable-slim
    depends_on:
      verify_required_env:
        condition: service_completed_successfully
    env_file:
      - ./.env
      - ../.env-local
    volumes:
      - nar_extensions:/mnt/jars
      - ./setup_jars.sh:/workspace/setup_jars.sh
    command: >
      bash /workspace/setup_jars.sh

  nifi:
    image: apache/nifi:${NIFI_VERSION}
    restart: unless-stopped
    platform: linux/amd64
    container_name: nifi
    depends_on:
      verify_required_env:
        condition: service_completed_successfully
      setup_jars:
        condition: service_completed_successfully
    env_file:
      - path: ../.env-local
        required: true
      - path: ./.env
        required: true
    ports:
      - ${EXT_NIFI_PORT}:8443
    volumes:
      - nar_extensions:/opt/nifi/nifi-current/nar_extensions:rw
      - state:/opt/nifi/nifi-current/state:rw
      - database_repository:/opt/nifi/nifi-current/database_repository:rw
      - flowfile_repository:/opt/nifi/nifi-current/flowfile_repository:rw
      - content_repository:/opt/nifi/nifi-current/content_repository:rw
      - provenance_repository:/opt/nifi/nifi-current/provenance_repository:rw

volumes:
  nar_extensions:
  state:
  database_repository:
  flowfile_repository:
  content_repository:
  provenance_repository:
